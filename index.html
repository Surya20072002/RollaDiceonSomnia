<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SOmnia Roll a Die DApp</title>
    <!-- Tailwind CSS via CDN for modern styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Inter font from Google Fonts -->
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap">
    <!-- Ethers.js library for blockchain interaction -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117;
        }

        .die-face {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 4px;
            width: 80px;
            height: 80px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.5s ease-in-out;
            border: 2px solid #334155;
        }

        .dot {
            width: 16px;
            height: 16px;
            background-color: #1e293b;
            border-radius: 50%;
            place-self: center;
        }
        
        .die-1 .dot:nth-child(1) { grid-area: 2 / 2 / 3 / 3; }

        .die-2 .dot:nth-child(1) { grid-area: 1 / 1 / 2 / 2; }
        .die-2 .dot:nth-child(2) { grid-area: 3 / 3 / 4 / 4; }

        .die-3 .dot:nth-child(1) { grid-area: 1 / 1 / 2 / 2; }
        .die-3 .dot:nth-child(2) { grid-area: 2 / 2 / 3 / 3; }
        .die-3 .dot:nth-child(3) { grid-area: 3 / 3 / 4 / 4; }

        .die-4 .dot:nth-child(1) { grid-area: 1 / 1 / 2 / 2; }
        .die-4 .dot:nth-child(2) { grid-area: 1 / 3 / 2 / 4; }
        .die-4 .dot:nth-child(3) { grid-area: 3 / 1 / 4 / 2; }
        .die-4 .dot:nth-child(4) { grid-area: 3 / 3 / 4 / 4; }

        .die-5 .dot:nth-child(1) { grid-area: 1 / 1 / 2 / 2; }
        .die-5 .dot:nth-child(2) { grid-area: 1 / 3 / 2 / 4; }
        .die-5 .dot:nth-child(3) { grid-area: 2 / 2 / 3 / 3; }
        .die-5 .dot:nth-child(4) { grid-area: 3 / 1 / 4 / 2; }
        .die-5 .dot:nth-child(5) { grid-area: 3 / 3 / 4 / 4; }

        .die-6 .dot:nth-child(1) { grid-area: 1 / 1 / 2 / 2; }
        .die-6 .dot:nth-child(2) { grid-area: 1 / 3 / 2 / 4; }
        .die-6 .dot:nth-child(3) { grid-area: 2 / 1 / 3 / 2; }
        .die-6 .dot:nth-child(4) { grid-area: 2 / 3 / 3 / 4; }
        .die-6 .dot:nth-child(5) { grid-area: 3 / 1 / 4 / 2; }
        .die-6 .dot:nth-child(6) { grid-area: 3 / 3 / 4 / 4; }

        .roll-animation {
            animation: roll 0.5s ease-in-out forwards;
        }

        @keyframes roll {
            0% { transform: rotateX(0deg) rotateY(0deg); }
            50% { transform: rotateX(180deg) rotateY(180deg); }
            100% { transform: rotateX(360deg) rotateY(360deg); }
        }

        .button-odd {
            background-image: linear-gradient(to right, #ef4444, #dc2626);
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .button-even {
            background-image: linear-gradient(to right, #22c55e, #16a34a);
            box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.4);
            transition: all 0.2s ease-in-out;
        }
        .button-odd:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(239, 68, 68, 0.6);
        }
        .button-even:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 8px -1px rgba(34, 197, 94, 0.6);
        }
        .button-odd:active, .button-even:active {
            transform: translateY(0);
        }
        .connect-button {
            background-color: #3b82f6;
            transition: background-color 0.2s ease-in-out;
        }
        .connect-button:hover {
            background-color: #60a5fa;
        }
        .bet-button {
            background-color: #4a5568;
            color: #d1d5db;
            transition: all 0.2s ease-in-out;
        }
        .bet-button:hover {
            background-color: #64748b;
        }
        .switch-button {
            background-color: #f59e0b;
            transition: background-color 0.2s ease-in-out;
        }
        .switch-button:hover {
            background-color: #fbbf24;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen text-gray-100 p-4">

    <!-- Main game container -->
    <div class="bg-gray-800 rounded-2xl shadow-2xl p-8 max-w-sm w-full space-y-6 text-center border-2 border-gray-700">
        <h1 class="text-4xl font-bold text-gray-50">SOmnia Die Roll</h1>
        <p class="text-gray-400">Bet on Odd or Even to win 2x!</p>

        <!-- Wallet connection status -->
        <div class="space-y-2">
            <button id="connect-button" class="connect-button text-white font-bold py-3 px-6 rounded-xl w-full">
                Connect Wallet
            </button>
            <div id="wallet-info" class="text-sm text-gray-400 break-words hidden">
                <p>Address: <span id="wallet-address" class="text-gray-200"></span></p>
                <p>Balance: <span id="wallet-balance" class="text-green-400"></span> STT</p>
            </div>
            <!-- Switch Network button -->
            <button id="switch-network-button" class="switch-button text-white font-bold py-3 px-6 rounded-xl w-full hidden">
                Switch to Somnia Testnet
            </button>
        </div>

        <!-- Die display area -->
        <div class="flex justify-center items-center h-24">
            <div id="die" class="die-face">
                <!-- Dots for the die face will be added by JavaScript -->
            </div>
        </div>

        <!-- Bet input and buttons -->
        <div class="space-y-4">
            <div class="flex items-center justify-center space-x-2">
                <input type="number" id="bet-amount" class="w-24 text-center bg-gray-700 text-gray-100 rounded-xl p-2" placeholder="Custom" min="0.001" step="0.001" disabled>
                <span class="text-gray-400">STT</span>
            </div>
            <!-- Quick bet buttons -->
            <div id="quick-bets" class="flex flex-wrap justify-center gap-2">
                <button class="bet-button px-4 py-2 rounded-xl text-sm" data-value="0.001" disabled>0.001</button>
                <button class="bet-button px-4 py-2 rounded-xl text-sm" data-value="0.01" disabled>0.01</button>
                <button class="bet-button px-4 py-2 rounded-xl text-sm" data-value="0.05" disabled>0.05</button>
                <button class="bet-button px-4 py-2 rounded-xl text-sm" data-value="0.1" disabled>0.1</button>
                <button class="bet-button px-4 py-2 rounded-xl text-sm" data-value="1" disabled>1</button>
            </div>

            <div class="flex justify-center space-x-4">
                <button id="odd-button" class="button-odd text-white font-bold py-3 px-6 rounded-xl w-1/2" disabled>
                    ODD
                </button>
                <button id="even-button" class="button-even text-white font-bold py-3 px-6 rounded-xl w-1/2" disabled>
                    EVEN
                </button>
            </div>
        </div>

        <!-- Result message box -->
        <div id="message-box" class="h-10 text-xl font-semibold">
            &nbsp; <!-- Non-breaking space to maintain height -->
        </div>
    </div>

    <script>
        // --- Network and DApp Configuration ---
        const somniaNetwork = {
            chainId: '0xC488', // 50312 in hex
            chainName: 'Somnia Testnet',
            rpcUrls: ['https://dream-rpc.somnia.network/'],
            nativeCurrency: { name: 'STT', symbol: 'STT', decimals: 18 },
            blockExplorerUrls: ['https://shannon-explorer.somnia.network/']
        };

        // --- Contract Details ---
        const CONTRACT_ADDRESS = "0xD4D707ad3d57289c1b52Cf2D3c6Ca99538EC5050";
        const CONTRACT_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "betAmount",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "enum DiceGame.Guess",
                        "name": "guess",
                        "type": "uint8"
                    }
                ],
                "name": "BetPlaced",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "rolledNumber",
                        "type": "uint256"
                    },
                    {
                        "indexed": false,
                        "internalType": "enum DiceGame.Guess",
                        "name": "playerGuess",
                        "type": "uint8"
                    },
                    {
                        "indexed": false,
                        "internalType": "bool",
                        "name": "isWinner",
                        "type": "bool"
                    }
                ],
                "name": "GameResult",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "enum DiceGame.Guess",
                        "name": "_guess",
                        "type": "uint8"
                    }
                ],
                "name": "placeBet",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "player",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "winnings",
                        "type": "uint256"
                    }
                ],
                "name": "WinningsPaid",
                "type": "event"
            },
            {
                "inputs": [],
                "name": "withdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "stateMutability": "payable",
                "type": "receive"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];


        // --- DOM Elements ---
        const dieElement = document.getElementById('die');
        const oddButton = document.getElementById('odd-button');
        const evenButton = document.getElementById('even-button');
        const betAmountInput = document.getElementById('bet-amount');
        const quickBetButtons = document.querySelectorAll('#quick-bets button');
        const messageBox = document.getElementById('message-box');
        const connectButton = document.getElementById('connect-button');
        const walletInfo = document.getElementById('wallet-info');
        const walletAddressSpan = document.getElementById('wallet-address');
        const walletBalanceSpan = document.getElementById('wallet-balance');
        const switchNetworkButton = document.getElementById('switch-network-button');

        // --- Global State ---
        let provider = null;
        let signer = null;
        let userAddress = null;
        let isWalletConnected = false;
        let diceGameContract = null;


        // --- Die Face Rendering Logic ---
        const renderDieFace = (number) => {
            dieElement.innerHTML = '';
            dieElement.className = 'die-face';
            dieElement.classList.add(`die-${number}`);
            for (let i = 0; i < number; i++) {
                const dot = document.createElement('div');
                dot.className = 'dot';
                dieElement.appendChild(dot);
            }
        };

        // --- Wallet Connection and Network Handling ---
        const enableGameControls = (enabled) => {
            betAmountInput.disabled = !enabled;
            oddButton.disabled = !enabled;
            evenButton.disabled = !enabled;
            quickBetButtons.forEach(button => button.disabled = !enabled);
        };

        const updateWalletUI = () => {
            if (isWalletConnected) {
                connectButton.textContent = 'Disconnect Wallet';
                walletInfo.classList.remove('hidden');
                walletAddressSpan.textContent = userAddress;
            } else {
                connectButton.textContent = 'Connect Wallet';
                walletInfo.classList.add('hidden');
                walletAddressSpan.textContent = '';
                walletBalanceSpan.textContent = '';
                enableGameControls(false);
            }
        };

        const updateBalance = async () => {
            if (provider && userAddress) {
                try {
                    const balance = await provider.getBalance(userAddress);
                    const formattedBalance = ethers.utils.formatEther(balance);
                    walletBalanceSpan.textContent = parseFloat(formattedBalance).toFixed(4);
                } catch (error) {
                    console.error("Failed to fetch balance:", error);
                }
            }
        };
        
        const switchNetwork = async () => {
             if (window.ethereum) {
                try {
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: somniaNetwork.chainId }],
                    });
                    // After the network switch, the 'chainChanged' event will fire,
                    // which will reload the page and re-connect the wallet.
                } catch (switchError) {
                    // This error code indicates that the chain has not been added to MetaMask.
                    if (switchError.code === 4902) {
                        try {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: somniaNetwork.chainId,
                                    rpcUrls: somniaNetwork.rpcUrls,
                                    chainName: somniaNetwork.chainName,
                                    nativeCurrency: somniaNetwork.nativeCurrency,
                                    blockExplorerUrls: somniaNetwork.blockExplorerUrls,
                                }],
                            });
                        } catch (addError) {
                            console.error("Failed to add network:", addError);
                        }
                    } else {
                        console.error("Failed to switch network:", switchError);
                    }
                }
            }
        };


        const connectWallet = async () => {
            if (window.ethereum) {
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    const chainId = await window.ethereum.request({ method: 'eth_chainId' });

                    // Check if on the correct network
                    if (chainId !== somniaNetwork.chainId) {
                        messageBox.textContent = "Please switch to the Somnia Testnet in your wallet.";
                        messageBox.className = 'text-red-400 h-10 text-xl font-semibold';
                        connectButton.classList.add('hidden');
                        switchNetworkButton.classList.remove('hidden');
                        enableGameControls(false); 
                        return;
                    }

                    // Request accounts and get signer
                    const accounts = await provider.send('eth_requestAccounts', []);
                    userAddress = accounts[0];
                    signer = provider.getSigner();
                    diceGameContract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                    isWalletConnected = true;
                    updateWalletUI();
                    updateBalance();
                    enableGameControls(true);
                    messageBox.textContent = "Wallet connected! Place your bet.";
                    messageBox.className = 'text-green-400 h-10 text-xl font-semibold';
                } catch (error) {
                    console.error("Connection failed:", error);
                    messageBox.textContent = "Connection to wallet failed. Please try again.";
                    messageBox.className = 'text-red-400 h-10 text-xl font-semibold';
                    isWalletConnected = false;
                }
            } else {
                messageBox.textContent = "MetaMask or another wallet is not installed. Please install one to play.";
                messageBox.className = 'text-yellow-400 h-10 text-xl font-semibold';
            }
        };

        const disconnectWallet = () => {
            // This is a soft disconnect for the UI. MetaMask doesn't have a formal disconnect API.
            userAddress = null;
            isWalletConnected = false;
            provider = null;
            signer = null;
            diceGameContract = null;
            updateWalletUI();
            messageBox.textContent = "Wallet disconnected.";
            messageBox.className = 'text-gray-400 h-10 text-xl font-semibold';
        };

        // Event listener for connect/disconnect button
        connectButton.addEventListener('click', () => {
            if (isWalletConnected) {
                disconnectWallet();
            } else {
                connectWallet();
            }
        });

        // Event listener for the new Switch Network button
        switchNetworkButton.addEventListener('click', switchNetwork);

        // Listen for account changes and network changes
        if (window.ethereum) {
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length > 0) {
                    userAddress = accounts[0];
                    updateWalletUI();
                    updateBalance();
                } else {
                    disconnectWallet();
                }
            });
            window.ethereum.on('chainChanged', () => {
                window.location.reload(); // Recommended by MetaMask for a clean state
            });
        }

        // --- Game Logic with Transactions ---
        const rollDie = async (userGuess) => {
            const betAmount = betAmountInput.value;
            if (!betAmount || parseFloat(betAmount) <= 0) {
                messageBox.textContent = "Please enter a valid bet amount.";
                messageBox.className = 'text-yellow-400 h-10 text-xl font-semibold';
                return;
            }

            const betAmountWei = ethers.utils.parseEther(betAmount);
            const balance = await provider.getBalance(userAddress);
            if (balance.lt(betAmountWei)) {
                messageBox.textContent = "Insufficient funds for this bet.";
                messageBox.className = 'text-red-400 h-10 text-xl font-semibold';
                return;
            }

            enableGameControls(false);
            messageBox.textContent = 'Processing transaction... Please confirm in your wallet.';
            messageBox.className = 'text-yellow-400 h-10 text-xl font-semibold';

            try {
                // Call the smart contract's placeBet function
                const guessValue = userGuess === 'odd' ? 0 : 1; // 0 for Odd, 1 for Even based on the enum in the contract
                
                const tx = await diceGameContract.placeBet(guessValue, { value: betAmountWei });
                messageBox.textContent = 'Transaction sent. Waiting for confirmation...';
                
                const receipt = await tx.wait(); // Wait for the transaction to be mined

                // Listen for events to determine the game result
                const gameResultEvent = receipt.events.find(e => e.event === 'GameResult');
                if (gameResultEvent) {
                    const rolledNumber = gameResultEvent.args.rolledNumber.toNumber();
                    const isWinner = gameResultEvent.args.isWinner;

                    dieElement.classList.add('roll-animation');
                    setTimeout(() => {
                        renderDieFace(rolledNumber);
                        dieElement.classList.remove('roll-animation');

                        if (isWinner) {
                            messageBox.textContent = `You won! It was ${rolledNumber}. You received ${betAmount * 2} STT.`;
                            messageBox.className = 'text-green-400 h-10 text-xl font-semibold';
                        } else {
                            messageBox.textContent = `You lost! It was ${rolledNumber}. Your bet of ${betAmount} STT is gone.`;
                            messageBox.className = 'text-red-400 h-10 text-xl font-semibold';
                        }

                        updateBalance();
                        enableGameControls(true);
                    }, 750);
                } else {
                    messageBox.textContent = "Game transaction confirmed, but no result event was found.";
                    messageBox.className = 'text-red-400 h-10 text-xl font-semibold';
                    updateBalance();
                    enableGameControls(true);
                }
            } catch (error) {
                console.error("Transaction failed:", error);
                if (error.code === 4001) {
                    messageBox.textContent = "Transaction rejected by user.";
                } else {
                    messageBox.textContent = `Transaction failed: ${error.message}`;
                }
                messageBox.className = 'text-red-400 h-10 text-xl font-semibold';
                enableGameControls(true);
            }
        };

        // --- Quick Bet Buttons Logic ---
        quickBetButtons.forEach(button => {
            button.addEventListener('click', () => {
                betAmountInput.value = button.getAttribute('data-value');
            });
        });

        // --- Event Listeners ---
        oddButton.addEventListener('click', () => rollDie('odd'));
        evenButton.addEventListener('click', () => rollDie('even'));

        // --- Initial State on Load ---
        window.onload = () => {
            renderDieFace(1); // Show the number 1 die face on load
            updateWalletUI(); // Set initial button state
        };
    </script>
</body>
</html>
